<head>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha384-vk5WoKIaW/vJyUAd9n/wmopsmNhiy+L2Z+SBxGYnUkunIxVxAv/UtMOhba/xskxh"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="bubble_ladder.css"/>
</head>
<body>
    <div class="ladder-container">
        <div style="position: relative">
            <img id="cursor" style="position: absolute; right: 4px; top: 14px; z-index: 1" src="images/bubble%20arrow.png"/>
        </div>
        <div id="ladder-table">
            <!-- GENERATED STUFF GOES HERE -->
        </div>
    </div>
<script>
    const ladderEl = $("#ladder-table");
    const cursorEl = $("#cursor");

    let ladderData = null;

    update();
    setInterval(update, 1000);

    function update() {
        $.get("bubble_ladder.json", function (json) {
            if (json !== ladderData) {
                try {
                    _data = JSON.parse(json);
                } catch (e) {
                    // When opened as a local file (not in OBS), json is already an object and not a string.
                    _data = json;
                }
                ladderData = _data;

                ladderEl.html(ladderData.ladder.map((bot, i) => {

                    let canMoveDown = true;
                    for (let cmp of ladderData.known_cmps) {
                        if (cmp.better === i && cmp.worse === i + 1) {
                            canMoveDown = false;
                            break;
                        }
                    }
                    let lock = canMoveDown ? "" : `<img style="position: absolute; right: 32px; bottom: -11px; z-index: 1" src="images/bubble%20lock.png" />`;

                    return `
<div class="ladder-item" style="position: relative">
    <div class="rank"><p class="center"></p>${i + 1}</div>
    <img class="logo" />
    <div class="bot-name">${bot}</div>
    ${lock}
</div>`
                }).join(""));

                if (ladderData.cur >= 0) {
                    cursorEl.show();
                    if (ladderData.direction === -1) {
                        cursorEl.css("top", `${ladderData.cur * 36 - 18}px`);
                        cursorEl.css("transform", "scaleY(1)");
                    } else {
                        cursorEl.css("top", `${ladderData.cur * 36 + 10}px`);
                        cursorEl.css("transform", "scaleY(-1)");
                    }
                } else {
                    cursorEl.hide();
                }
            }
        });
    }
</script>
</body>